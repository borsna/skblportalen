{% extends "layout.html" %}
{% set show_lang_switch = show_lang_switch %}
{% block title %}skbl.se - {{ title }}{% endblock %}
{% block content %}
<div class="col-md-8">
    <h1>{{ headline | deescape }}</h1>

    <a href="javascript:void(0)" id="show-map-button">Visa karta <span class="glyphicon glyphicon-globe"></span></a><br/>
    <div id="mapid" style="height: 280px;display:none;width: 100%"></div>

    {% if subheadline %}
    <h2>{{ subheadline | deescape }} {% if search and hits.hits%}({% if more %}{{hits.hits|length}} {{ gettext('of') }} {% endif %}{{ hits.total }}){% endif %}</h2>
       <br/>
    {% endif %}
    {% if authorinfo %}
        <h4 itemprop="jobTitle">{{ authorinfo[0] | safe}}</h4>
        {% if authorinfo[1] %}
            <div class="authorinfo">
                {{ gettext("Has published (amongst others)") }}:
                <ul>
                {% for pub in authorinfo[1] %}
                    <li>{{pub | safe}}</li>
                {% endfor %}
            </div>
        {% endif %}
        <br/>
        <h4>{{ gettext("Articles in SKBL") }}:</h4>
    {% endif %}
    {% if infotext %}
        <p>{{ infotext}}</p>
        <br/>
    {% endif %}
    {% if search and not hits.hits%}
        <span>{{ gettext("No results found for") }} "{{search}}".</span>
    {% endif %}


    {% set firsthits = {}%}
    {% if hits_name %}
    <p>
    {% set namelist, firsthits = make_simplenamelist(hits_name)%}
        <ul>
        {% for score, name, liferange, subtitle, subtitle_eng, subject_id in namelist %}
            <li>
                <a href="{{ url_for('views.article_'+g.language, id=subject_id) }}">{{ name | safe }}<br />
                {% set article_subtitle = get_lang_text(subtitle, subtitle_eng, g.language) %}
                {% if article_subtitle %} {{ article_subtitle | safe}}<br> {% endif %}
                {% if liferange[0] or  liferange[1] %}
                    <span itemprop="birthDate">{{ liferange[0] }}</span> &mdash; <span itemprop="deathDate">{{ liferange[1] }}</span>
                {% endif %}
                </a>
            </li>
        {% endfor %}
        </ul>
    <p>
    {% endif %}

    {% set firstletters, results = make_namelist(hits, firsthits)%}
    {% if namelist and results %}
    <div class="top-link"><a href="#top">[ {{gettext("TO THE TOP")}} ]</a></div>
    {% endif %}
    {% if split_letters %}
        {% for firstletter in firstletters%}
            {% if firstletter == firstletters[-1] %}
                <a class="alphabetlist" href="#{{firstletter}}">{{firstletter}}</a>
            {% else %}
                <a class="alphabetlist vertical_bar" href="#{{firstletter}}">{{firstletter}}</a>
            {% endif %}
        {% endfor %}
    {% endif %}
    <ul>
    {% for oneletterlist in results %}
        {% if split_letters %}
            <h2><a class="no_anchor_decor" name="{{ oneletterlist[0][0] }}">{{ oneletterlist[0][0] }}</a></h2>
        {% endif %}
        {% for _firstletter, is_link, name, linked_name, liferange, subtitle, subtitle_eng, subject_id in oneletterlist %}
        <li>
            {% if is_link %}
                <a href="{{ url_for('views.article_'+g.language, id=subject_id) }}" title="{{ linked_name }}"><strong><em>{{ name }}</em></strong>&ensp;<span class="glyphicon glyphicon-link"></span><br />
            {% else %}
                <a href="{{ url_for('views.article_'+g.language, id=subject_id) }}">{{ name | safe }}<br />
            {% endif %}
            {% set article_subtitle = get_lang_text(subtitle, subtitle_eng, g.language) %}
            {% if article_subtitle %} {{ article_subtitle | safe}}<br> {% endif %}
            {% if liferange[0] or  liferange[1] %}
                <span itemprop="birthDate">{{ liferange[0] }}</span> &mdash; <span itemprop="deathDate">{{ liferange[1] }}</span>
            {% endif %}
            </a>
        </li>
        {% endfor %}
        {% if split_letters and oneletterlist %}
        <div class="top-link"><a href="#top">[ {{gettext("TO THE TOP")}} ]</a></div>
        {% endif %}
    {% endfor %}
    </ul>
    {% if not split_letters %}
    <div class="top-link"><a href="#top">[ {{gettext("TO THE TOP")}} ]</a></div>
    {% endif %}
    {% if more %}
       <div class="karp-link">
        {{gettext("Not all hits are shown.")}} {{gettext("To see more hits, use Språkbanken's tool")}}
                <a class="visible_link" href="{{karp_url}}" target="_blank">Karp</a> ({{ gettext('External link') }})
        </div>
    {% endif %}


</div>
<div class="col-md-4">
    {{ advanced_search_text | safe}}
    {% if picture %}
    <img src="{{ picture }}" alt="{{ headline }}" width="350px" />
    {% endif %}
</div>
{% endblock %}

{% block foot %}
    {{ super() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
        jQuery(document).ready(function() {
            var indata = {{hits.hits|tojson}};

            var skblmap = L.map('mapid').setView([57.70887, 11.97456], 6);
            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.streets'
            }).addTo(skblmap);


            window.mapInstance = skblmap;

            var markersBorn = L.markerClusterGroup({singleMarkerMode: true, maxClusterRadius: 50});
            var markersDeath = L.markerClusterGroup({singleMarkerMode: true, maxClusterRadius: 50});
            var markersEducation = L.markerClusterGroup({singleMarkerMode: true, maxClusterRadius: 50});
            var markersOccupation = L.markerClusterGroup({singleMarkerMode: true, maxClusterRadius: 50});
            var markersPlaces = L.markerClusterGroup({singleMarkerMode: true, maxClusterRadius: 50});

            $("#show-map-button").click(function() {
                $("#mapid").show();
                window.mapInstance.invalidateSize();
            });

            for (var hit of indata) {
                var s = hit._source;
                var name = s.name.lastname + ", " + s.name.firstname.replace(/\//g, '');
                if (s.lifespan && s.lifespan.from && s.lifespan.from.place && s.lifespan.from.place.pin) {
                    var pin = s.lifespan.from.place.pin;
                    markersBorn.addLayer(L.marker([pin.lat, pin.lon]).bindTooltip(name).on('click', function() { console.log(name); })).addTo(skblmap);
                }
                if (s.lifespan && s.lifespan.to && s.lifespan.to.place && s.lifespan.to.place.pin) {
                    var pin = s.lifespan.to.place.pin;
                    markersDeath.addLayer(L.marker([pin.lat, pin.lon]).bindTooltip(name).on('click', function() { console.log(name); }));
                }
                if (s.education) {
                    if (! $.isArray(s.education)) s.education = [s.education];
                    for (edu of s.education) {
                        if (edu.place && edu.place.pin) {
                            var pin = edu.place.pin;
                            markersEducation.addLayer(L.marker([pin.lat, pin.lon]).bindTooltip(name).on('click', function() { console.log(name); }));
                        }
                    }
                }
                if (s.occupation) {
                    if (! $.isArray(s.occupation)) s.occupation = [s.occupation];
                    for (occ of s.occupation) {
                        if (occ.place && occ.place.pin) {
                            var pin = occ.place.pin;
                            markersOccupation.addLayer(L.marker([pin.lat, pin.lon]).bindTooltip(name).on('click', function() { console.log(name); }));
                        }
                    }
                }
                if (s.places) {
                    if (! $.isArray(s.places)) s.places = [s.places];
                    for (p of s.places) {
                        if (p.place && p.place.pin) {
                            var pin = p.place.pin;
                            markersPlaces.addLayer(L.marker([pin.lat, pin.lon]).bindTooltip(name).on('click', function() { console.log(name); }));
                        }
                    }
                }
            }
            var makerLayers = {
                "Födelseorter": markersBorn,
                "Dödsorter": markersDeath,
                "Utbildningsorter": markersEducation,
                "Verksamhetsorter": markersOccupation,
                "Bostadsorter": markersPlaces,
            };
            L.control.layers(makerLayers, null).addTo(skblmap);
        });
    </script>
{% endblock %}